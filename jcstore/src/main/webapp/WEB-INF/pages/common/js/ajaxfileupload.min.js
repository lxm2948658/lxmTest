jQuery.extend({createUploadIframe:function(e,t){var r="jUploadFrame"+e,o='<iframe id="'+r+'" name="'+r+'" style="position:absolute; top:-9999px; left:-9999px"';return window.ActiveXObject&&("boolean"==typeof t?o+=' src="javascript:false"':"string"==typeof t&&(o+=' src="'+t+'"')),o+=" />",jQuery(o).appendTo(document.body),jQuery("#"+r).get(0)},createUploadForm:function(e,t,r){var o="jUploadForm"+e,n="jUploadFile"+e,a=jQuery('<form  action="" method="POST" name="'+o+'" id="'+o+'" enctype="multipart/form-data"></form>');if(r)for(var u in r)jQuery('<input type="hidden" name="'+u+'" value="'+r[u]+'" />').appendTo(a);var c=jQuery("#"+t),d=jQuery(c).clone();return jQuery(c).attr("id",n),jQuery(c).before(d),jQuery(c).appendTo(a),jQuery(a).css("position","absolute"),jQuery(a).css("top","-1200px"),jQuery(a).css("left","-1200px"),jQuery(a).appendTo("body"),a},ajaxFileUpload:function(e){e=jQuery.extend({},jQuery.ajaxSettings,e);var t=(new Date).getTime(),r=jQuery.createUploadForm(t,e.fileElementId,"undefined"==typeof e.data?!1:e.data),o=(jQuery.createUploadIframe(t,e.secureuri),"jUploadFrame"+t),n="jUploadForm"+t;e.global&&!jQuery.active++&&jQuery.event.trigger("ajaxStart");var a=!1,u={};e.global&&jQuery.event.trigger("ajaxSend",[u,e]);var c=function(t){var n=document.getElementById(o);try{n.contentWindow?(u.responseText=n.contentWindow.document.body?n.contentWindow.document.body.innerText:null,u.responseText=u.responseText?u.responseText:n.contentWindow.document.body.textContent,u.responseXML=n.contentWindow.document.XMLDocument?n.contentWindow.document.XMLDocument:n.contentWindow.document):n.contentDocument&&(u.responseText=n.contentDocument.document.body?n.contentDocument.document.body.innerHTML:null,u.responseXML=n.contentDocument.document.XMLDocument?n.contentDocument.document.XMLDocument:n.contentDocument.document)}catch(c){jQuery.handleError(e,u,null,c)}if(u||"timeout"==t){a=!0;var d;try{if(d="timeout"!=t?"success":"error","error"!=d){var l=jQuery.uploadHttpData(u,e.dataType);e.success&&e.success(l,d),e.global&&jQuery.event.trigger("ajaxSuccess",[u,e])}else jQuery.handleError(e,u,d)}catch(c){d="error",jQuery.handleError(e,u,d,c)}e.global&&jQuery.event.trigger("ajaxComplete",[u,e]),e.global&&!--jQuery.active&&jQuery.event.trigger("ajaxStop"),e.complete&&e.complete(u,d),jQuery(n).unbind(),setTimeout(function(){try{jQuery(n).remove(),jQuery(r).remove()}catch(t){jQuery.handleError(e,u,null,t)}},100),u=null}};e.timeout>0&&setTimeout(function(){a||c("timeout")},e.timeout);try{var r=jQuery("#"+n);jQuery(r).attr("action",e.url),jQuery(r).attr("method","POST"),jQuery(r).attr("target",o),r.encoding?jQuery(r).attr("encoding","multipart/form-data"):jQuery(r).attr("enctype","multipart/form-data"),jQuery(r).submit()}catch(d){jQuery.handleError(e,u,null,d)}return jQuery("#"+o).load(c),{abort:function(){}}},handleError:function(e,t,r,o){e.error&&e.error.call(e.context||e,t,r,o),e.global&&(e.context?jQuery(e.context):jQuery.event).trigger("ajaxError",[t,e,o])},uploadHttpData:function(r,type){var data=!type;return data="xml"==type||data?r.responseXML:r.responseText,"script"==type&&jQuery.globalEval(data),"json"==type&&eval("data = "+data),"html"==type&&jQuery("<div>").html(data).evalScripts(),data}});
var ajaxUpload = (function() {
    var ajaxUpload = function(cfg) {
        //私有属性
        this.el = $(cfg.el); //上传的input
        this.url = cfg.url; //上传路径
        this.withWH = cfg.withWH;//是否带宽高
        this.callbackFn = cfg.callbackFn; //回掉函数
        this.uploadWrap = this.el.parents(".ajaxupload-wrap");//当前上传的父元素
        this.image = this.uploadWrap.find(".ajaxupload-image");//显示出来的图片
        this.uploadText = this.uploadWrap.find(".ajaxupload-upload-text");//显示的文字
        this.uploadBtn = this.uploadWrap.find(".uploadfile");//上传按钮
        this.deleteBtn = this.uploadWrap.find(".ajaxupload-delete-btn");//删除按钮
        this.imageWrap = this.uploadWrap.find(".ajaxupload-image-wrap");//图片区域
        this.postImage = this.uploadWrap.find(".upload-image");//隐藏域
        this.init(); //初始化
    };

    ajaxUpload.prototype.init = function() {
        var _this = this;
        var uploadId = this.el.attr("id");
        this.imageWrap.removeClass("ajaxupload-hide").css({
        	"height":"130px",
        	"line-height":"130px"
        });
        this.image.attr("src",domainUrl+"/assets/common/loading.gif");
        _this.ajaxFileUpload(uploadId);

        // 点击删除
        this.deleteBtn.off("click").on("click",function (){
            _this.deleteFn();
        });
    };
    //返回函数
    ajaxUpload.prototype.setCallbackFn = function(callbackdata) {
    	this.deleteBtn.removeClass("ajaxupload-hide");
    	this.setCallbackData(callbackdata.path);
        this.imageWrap.removeClass("ajaxupload-hide").css({
            "height":"auto",
            "line-height":"auto"
        });
    };
    //设置返回的数据
    ajaxUpload.prototype.setCallbackData = function(imgurl){
        this.image.attr("src",imgurl);
        this.postImage.val(imgurl);
        this.uploadText.text(imgurl.length >0 ?"重新上传":"上传图片");
    }
    //点击删除
    ajaxUpload.prototype.deleteFn = function(){
        this.imageWrap.addClass("ajaxupload-hide");
        this.deleteBtn.addClass("ajaxupload-hide");
        this.setCallbackData("");
    }
    
    //上传
    ajaxUpload.prototype.ajaxFileUpload = function(uploadId) {
        var _this = this;
        $.ajaxFileUpload({
            fileElementId: uploadId,
            url: this.url,
            secureuri: false,
            data:{"withWH":_this.withWH,"width":10,"height":10},
            dataType: 'json',
            success: function(data, status) {
                _this.setCallbackFn(data);
                _this.callbackFn.call(this, status, _this.el, data);
            },
            error: function(data, status, e) {}
        });
    }

    return ajaxUpload;
})();
(function(){
	var delBtn = $(".ajaxupload-delete-btn");
	var parent = delBtn.parents(".ajaxupload-wrap")
	delBtn.off("click").on("click",function(){
		var img = parent.find('.ajaxupload-image-wrap');
		img.addClass("ajaxupload-hide");
		img.find("input").val('');
        $(this).addClass("ajaxupload-hide");
	});
	delBtn.find(".ajaxupload-image").addClass(".click-view");
})()

